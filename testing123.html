<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Rekapan Data dari Google Sheet</title>
    <!-- Bootstrap CSS -->
    <link href="https://stackpath.bootstrapcdn.com/bootstrap/4.5.2/css/bootstrap.min.css" rel="stylesheet">
    <style>
        .highlight-red {
            background-color: #f8d7da; /* Warna latar belakang merah muda untuk baris dengan nilai "-" di kolom O */
        }

        /* Ukuran lebar kolom yang sama */
        th, td {
            text-align: center; /* Rata tengah teks */
        }

        th {
            text-align: center; /* Rata tengah teks header */
        }

        /* Lebar kolom yang diatur */
        th:nth-child(1), td:nth-child(1) {
            width: 240px; /* Lebar kolom nama dua kali lebar kolom lainnya */
            text-align: left; /* Rata kiri teks pada kolom nama */
        }

        th:nth-child(n+2), td:nth-child(n+2) {
            width: 120px; /* Lebar kolom O, P0, P100, Sakit, Izin */
        }
    </style>
</head>
<body>
    <div class="container mt-5">
        <h2 class="text-center">Rekapan Data</h2>

        <!-- Spinner Loading -->
        <div id="loadingSpinner" class="d-flex justify-content-center align-items-center">
            <div class="spinner-border text-primary" role="status">
                <span class="sr-only">Loading...</span>
            </div>
        </div>

        <!-- Filter Tanggal -->
        <div class="form-group">
            <label for="dateFilter">Pilih Tanggal:</label>
            <input type="date" class="form-control" id="dateFilter">
        </div>

        <!-- Tabel Rekapan -->
        <table class="table table-striped mt-3" id="rekapanTable">
            <thead>
                <tr>
                    <th>Nama</th>
                    <th>O</th>
                    <th>P0</th>
                    <th>P100</th>
                    <th>Sakit</th>
                    <th>Izin</th>
                </tr>
            </thead>
            <tbody>
                <!-- Data akan diisi secara dinamis -->
            </tbody>
        </table>
    </div>

    <!-- JavaScript -->
    <script>
        document.addEventListener("DOMContentLoaded", function() {
            const loadingSpinner = document.getElementById('loadingSpinner');
            const rekapanTableBody = document.querySelector('#rekapanTable tbody');
            const dateFilter = document.getElementById('dateFilter');

            // Set nilai default date menjadi hari ini (today)
            const today = new Date().toISOString().split('T')[0];
            dateFilter.value = today;

            // Link ke Google Sheet CSV
            const googleSheetUrl = 'https://docs.google.com/spreadsheets/d/1Lw906Dx-uFzBZZTbYOHmVsd8xHBf_g0jpstEZe6IwKo/pub?gid=1446253290&single=true&output=csv';
            let allData = [];
            let allNames = new Set();

            // Fetch data dari Google Sheet
            fetch(googleSheetUrl)
                .then(response => response.text())
                .then(csvText => {
                    // Parse CSV ke Array
                    allData = csvText.split('\n').slice(1).map(row => row.split(',').map(cell => cell.trim()));

                    // Ambil semua nama dari kolom 2 (index 1) dengan panjang maksimal 30 karakter
                    allData.forEach(row => {
                        const name = row[1]?.trim(); // Ambil nama dan trim whitespace
                        if (name && name !== "Nama" && name.length <= 30) { // Pastikan nama tidak kosong, bukan header, dan panjang <= 30
                            allNames.add(name);
                        }
                    });

                    // Perbarui tabel dengan data yang difilter secara otomatis (default date = today)
                    updateTable();

                    // Event listener untuk memperbarui tabel ketika filter tanggal berubah
                    dateFilter.addEventListener('change', updateTable);
                });

            // Fungsi untuk memperbarui tabel berdasarkan tanggal yang dipilih
            function updateTable() {
                const selectedDate = dateFilter.value;

                // Bersihkan tabel sebelum memuat data baru
                rekapanTableBody.innerHTML = '';

                // Filter data berdasarkan tanggal yang dipilih
                const filteredData = allData.filter(row => {
                    // Parse tanggal dari kolom pertama (index 0)
                    const timestamp = new Date(row[0]);
                    if (isNaN(timestamp.getTime())) {
                        // Jika timestamp tidak valid, skip data
                        return false;
                    }
                    const rowDate = timestamp.toISOString().split('T')[0]; // Format YYYY-MM-DD
                    return rowDate === selectedDate;
                });

                // Hitung O, P0, P100, Sakit, Izin dari kolom ke-9 (index 8)
                const reportData = {};
                filteredData.forEach(row => {
                    const name = row[1] || "Unknown";
                    const status = row[8] || "-";

                    if (!reportData[name]) {
                        reportData[name] = { O: "-", P0: "-", P100: "-", Sakit: "-", Izin: "-" };
                    }

                    if (status === "O") reportData[name].O = reportData[name].O === "-" ? 1 : reportData[name].O + 1;
                    else if (status === "P0") reportData[name].P0 = reportData[name].P0 === "-" ? 1 : reportData[name].P0 + 1;
                    else if (status === "P100") reportData[name].P100 = reportData[name].P100 === "-" ? 1 : reportData[name].P100 + 1;
                    else if (status === "Sakit") reportData[name].Sakit = reportData[name].Sakit === "-" ? 1 : reportData[name].Sakit + 1;
                    else if (status === "Izin") reportData[name].Izin = reportData[name].Izin === "-" ? 1 : reportData[name].Izin + 1;
                });

                // Urutkan nama secara ascending dan tampilkan nama-nama yang mungkin tidak memiliki data
                Array.from(allNames).sort().forEach(name => {
                    const data = reportData[name] || { O: "-", P0: "-", P100: "-", Sakit: "-", Izin: "-" };

                    // Buat baris tabel
                    const row = document.createElement('tr');
                    const isHighlighted = data.O === "-";
                    if (isHighlighted) {
                        row.classList.add('highlight-red');
                    }

                    row.innerHTML = `
                        <td>${name}</td>
                        <td>${data.O}</td>
                        <td>${data.P0}</td>
                        <td>${data.P100}</td>
                        <td>${data.Sakit}</td>
                        <td>${data.Izin}</td>
                    `;
                    rekapanTableBody.appendChild(row);
                });

                // Sembunyikan spinner loading setelah data siap
                loadingSpinner.style.display = 'none';
            }
        });
    </script>

    <!-- Bootstrap JS (optional, jika menggunakan komponen JS dari Bootstrap) -->
    <script src="https://code.jquery.com/jquery-3.5.1.slim.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/@popperjs/core@2.9.1/dist/umd/popper.min.js"></script>
    <script src="https://stackpath.bootstrapcdn.com/bootstrap/4.5.2/js/bootstrap.min.js"></script>
</body>
</html>
