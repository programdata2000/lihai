<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Rekap Data dan Pilihan Google Sheet</title>
    <!-- Bootstrap CSS -->
    <link href="https://stackpath.bootstrapcdn.com/bootstrap/4.5.2/css/bootstrap.min.css" rel="stylesheet">
    <style>
        .highlight-red {
            background-color: #f8d7da;
        }

        th, td {
            text-align: center;
        }

        th {
            text-align: center;
        }

        th:nth-child(1), td:nth-child(1) {
            width: 240px;
            text-align: left;
        }

        th:nth-child(n+2), td:nth-child(n+2) {
            width: 120px;
        }

        #loadingSpinner {
            display: none;
            position: absolute;
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%);
        }
    </style>
</head>
<body>
    <div class="container mt-5">
        <h2 class="text-center">Pilih Wilayah, Juru dan Rekapan Data</h2>

        <!-- Dropdown Wilayah -->
        <div class="form-group">
            <label for="wilayahDropdown">Pilih Wilayah:</label>
            <select class="form-control" id="wilayahDropdown">
                <option value="">-- Pilih Wilayah --</option>
                <option value="1">Wilayah 1</option>
                <option value="2">Wilayah 2</option>
                <option value="3">Wilayah 3</option>
                <option value="4">Wilayah 4</option>
            </select>
        </div>

        <!-- Dropdown Nama Juru -->
        <div class="form-group">
            <label for="juruDropdown">Pilih Nama Juru:</label>
            <select class="form-control" id="juruDropdown" disabled>
                <option value="">-- Pilih Nama Juru --</option>
            </select>
        </div>

        <!-- Filter Tanggal -->
        <div class="form-group">
            <label for="dateFilter">Pilih Tanggal:</label>
            <input type="date" class="form-control" id="dateFilter">
        </div>

        <!-- Spinner Loading -->
        <div id="loadingSpinner" class="d-flex justify-content-center align-items-center">
            <div class="spinner-border text-primary" role="status">
                <span class="sr-only">Loading...</span>
            </div>
        </div>

        <!-- Tabel Rekapan -->
        <table class="table table-striped mt-3" id="rekapanTable">
            <thead>
                <tr>
                    <th>Nama</th>
                    <th>O</th>
                    <th>P0</th>
                    <th>P100</th>
                    <th>Sakit</th>
                    <th>Izin</th>
                </tr>
            </thead>
            <tbody>
                <!-- Data akan diisi secara dinamis -->
            </tbody>
        </table>
    </div>

    <!-- JavaScript -->
    <script>
        // Data wilayah, juru, dan Google Sheet
        const data = [
            { wilayah: '1', nama: 'EMIL SALIM', id: '1Lw906Dx-uFzBZZTbYOHmVsd8xHBf_g0jpstEZe6IwKo', gid: '629954115' },
            { wilayah: '1', nama: 'YANRIZAL', id: '1Lw906Dx-uFzBZZTbYOHmVsd8xHBf_g0jpstEZe6IwKo', gid: '2143598053' },
            { wilayah: '2', nama: 'JAMALUDDIN', id: '1Lw906Dx-uFzBZZTbYOHmVsd8xHBf_g0jpstEZe6IwKo', gid: '1901095434' },
            { wilayah: '2', nama: 'ALAMSYAH', id: '1Lw906Dx-uFzBZZTbYOHmVsd8xHBf_g0jpstEZe6IwKo', gid: '1446253290' },
            { wilayah: '3', nama: 'KUSNANTO', id: '1Lw906Dx-uFzBZZTbYOHmVsd8xHBf_g0jpstEZe6IwKo', gid: '1539767816' },
            { wilayah: '3', nama: 'ALDA IRAWAN', id: '1Lw906Dx-uFzBZZTbYOHmVsd8xHBf_g0jpstEZe6IwKo', gid: '216012663' },
            { wilayah: '4', nama: 'IDRI RAPIS', id: '1Lw906Dx-uFzBZZTbYOHmVsd8xHBf_g0jpstEZe6IwKo', gid: '1558156392' }
        ];

        const wilayahDropdown = document.getElementById('wilayahDropdown');
        const juruDropdown = document.getElementById('juruDropdown');
        const loadingSpinner = document.getElementById('loadingSpinner');
        const rekapanTableBody = document.querySelector('#rekapanTable tbody');
        const dateFilter = document.getElementById('dateFilter');
        let allData = [];

        // Set nilai default date menjadi hari ini (today)
        const today = new Date().toISOString().split('T')[0];
        dateFilter.value = today;

        // Event listener untuk dropdown wilayah
        wilayahDropdown.addEventListener('change', function() {
            const selectedWilayah = this.value;

            // Kosongkan dropdown nama juru
            juruDropdown.innerHTML = '<option value="">-- Pilih Nama Juru --</option>';
            juruDropdown.disabled = true;
            allData = []; // Kosongkan data sebelumnya

            if (selectedWilayah) {
                const filteredData = data.filter(item => item.wilayah === selectedWilayah);
                juruDropdown.disabled = false;

                // Isi dropdown nama juru berdasarkan wilayah yang dipilih
                filteredData.forEach(item => {
                    const option = document.createElement('option');
                    option.value = item.nama;
                    option.textContent = item.nama;
                    juruDropdown.appendChild(option);
                });

                // Refresh tabel setelah filter wilayah berubah
                refreshTable();
            }
        });

        // Event listener untuk dropdown juru
        juruDropdown.addEventListener('change', function() {
            refreshTable();
        });

        // Event listener untuk filter tanggal
        dateFilter.addEventListener('change', refreshTable);

        // Fungsi untuk memperbarui tabel berdasarkan filter
        function refreshTable() {
            const selectedNama = juruDropdown.value;
            const selectedDate = dateFilter.value;

            // Cari data juru yang dipilih
            const selectedData = data.filter(item => item.wilayah === wilayahDropdown.value);

            // Tampilkan spinner loading saat data dimuat
            loadingSpinner.style.display = 'block';
            rekapanTableBody.innerHTML = ''; // Kosongkan tabel

            if (selectedData.length > 0) {
                // Sort data by name alphabetically
                const sortedNames = selectedData.map(item => item.nama).sort();

                // Fetch data Google Sheet dari setiap juru di wilayah yang dipilih
                Promise.all(selectedData.map(juru =>
                    fetch(`https://docs.google.com/spreadsheets/d/${juru.id}/pub?gid=${juru.gid}&single=true&output=csv`)
                        .then(response => response.text())
                        .then(csvText => {
                            // Split CSV text and limit columns to the first 9 columns
                            const rows = csvText.split('\n').slice(1).map(row => row.split(',').slice(0, 9).map(cell => cell.trim()));
                            return { name: juru.nama, rows };
                        })
                )).then(results => {
                    const reportData = {};
                    results.forEach(result => {
                        reportData[result.name] = { O: "-", P0: "-", P100: "-", Sakit: "-", Izin: "-" };

                        result.rows.forEach(row => {
                            const timestamp = new Date(row[0]);
                            if (!isNaN(timestamp.getTime())) { // Check if date is valid
                                const rowDate = timestamp.toISOString().split('T')[0];
                                if (rowDate === selectedDate) {
                                    const status = row[8] || "-";
                                    if (status === "O") reportData[result.name].O = reportData[result.name].O === "-" ? 1 : reportData[result.name].O + 1;
                                    else if (status === "P0") reportData[result.name].P0 = reportData[result.name].P0 === "-" ? 1 : reportData[result.name].P0 + 1;
                                    else if (status === "P100") reportData[result.name].P100 = reportData[result.name].P100 === "-" ? 1 : reportData[result.name].P100 + 1;
                                    else if (status === "Sakit") reportData[result.name].Sakit = reportData[result.name].Sakit === "-" ? 1 : reportData[result.name].Sakit + 1;
                                    else if (status === "Izin") reportData[result.name].Izin = reportData[result.name].Izin === "-" ? 1 : reportData[result.name].Izin + 1;
                                }
                            } else {
                                console.warn('Skipping invalid date:', row[0]);
                            }
                        });
                    });

                    // Display all names sorted and ensure they appear in the table even without data
                    sortedNames.forEach(name => {
                        const row = reportData[name] || { O: "-", P0: "-", P100: "-", Sakit: "-", Izin: "-" };
                        const tr = document.createElement('tr');
                        tr.innerHTML = `
                            <td>${name}</td>
                            <td>${row.O}</td>
                            <td>${row.P0}</td>
                            <td>${row.P100}</td>
                            <td>${row.Sakit}</td>
                            <td>${row.Izin}</td>
                        `;
                        rekapanTableBody.appendChild(tr);
                    });

                    // Sembunyikan spinner setelah data siap
                    loadingSpinner.style.display = 'none';
                });
            } else {
                // Sembunyikan spinner jika tidak ada data yang ditemukan
                loadingSpinner.style.display = 'none';
            }
        }
    </script>
</body>
</html>
